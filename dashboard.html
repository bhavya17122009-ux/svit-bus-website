<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVIT Live Dashboard</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; }
        body { background:#f4f7f6; margin:0; padding:10px; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
        .container { width: 98%; max-width: 1200px; margin: auto; flex: 1; }
        #map { height: 380px; width: 100%; border-radius: 12px; margin-bottom: 20px; border: 2px solid var(--accent); z-index: 1; }
        .driver-panel { display:none; background:#e8f8f5; padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid var(--success); }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .btn { padding:12px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; color: white; display: inline-block; margin-top: 5px; }
        
        /* Emergency Footer Styles */
        .emergency-footer { background: white; border-top: 3px solid var(--danger); padding: 20px; margin-top: 20px; border-radius: 12px 12px 0 0; }
        .emergency-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center; }
        .emergency-link { text-decoration: none; color: var(--danger); font-weight: bold; font-size: 14px; padding: 10px; border: 1px solid #ffeded; border-radius: 8px; background: #fffafa; }
    </style>
</head>
<body>

    <audio id="wakeLockAudio" loop>
        <source src="https://github.com/anars/blank-audio/raw/master/250-milliseconds-of-silence.mp3" type="audio/mpeg">
    </audio>

    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:var(--primary);">üöÄ SVIT Smart Transit</h2>
            <button onclick="logout()" class="btn" style="background:var(--danger); color:white;">Logout</button>
        </div>

        <div id="map"></div>

        <div id="driverControls" class="driver-panel">
            <h3 style="margin-top:0; color:var(--success);">üöç Driver Console</h3>
            <div style="display:flex; gap:10px; flex-wrap: wrap; margin-bottom: 15px;">
                <select id="busId" style="padding:12px; border-radius:6px; border:1px solid #ddd;">
                    <option>GJ-23-y-9599</option><option>GJ-23-aw-0090</option><option>GJ-23-y-9959</option><option>GJ-23-at-9972</option><option>GJ-23-aw-0900</option>
                    <option>GJ-23-at-0900</option><option>GJ-23-aw-0909</option><option>GJ-23-at-0909</option><option>GJ-23-aw-9729</option><option>GJ-23-aw-9279</option>
                    <option>GJ-23-ay-2799</option><option>GJ-23-ay-3699</option><option>GJ-23-ay-4599</option><option>GJ-23-ay-5499</option><option>GJ-23-ay-7299</option>
                    <option>GJ-23-aw-9999</option><option>GJ-23-ay-9999</option><option>GJ-23-aw-8735</option><option>GJ-23-aw-8788</option><option>GJ-23-aw-8982</option>
                </select>
                <select id="routeSelect" style="padding:12px; border-radius:6px; border:1px solid #ddd; flex-grow:1;"></select>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="confirmTrip()" class="btn" style="background:var(--success); color:white; flex:2;">üöÄ START TRACKING</button>
                <button onclick="removeRoute()" class="btn" style="background:var(--warning); color:white; flex:1;">üõë END TRIP</button>
                <button onclick="clearAll()" class="btn" style="background:var(--danger); color:white; flex:1;">RESET</button>
            </div>
            <p id="lockStatus" style="font-size:12px; color:var(--danger); margin-top:10px;">‚ö†Ô∏è Keep this app installed and minimize to track.</p>
        </div>

        <input type="text" id="searchInput" onkeyup="search()" placeholder="üîç Search Stop or Route..." style="width:100%; padding:15px; border-radius:10px; border:1px solid #ddd; margin-bottom:20px; box-sizing: border-box;">

        <table>
            <thead><tr><th>Bus Detail</th><th>Route & Stops</th><th>ETA / Traffic</th><th>Status</th></tr></thead>
            <tbody id="allocationBody"></tbody>
        </table>
    </div>

    <div class="emergency-footer">
        <h3 style="margin-top:0; color:var(--danger); text-align: center; font-size: 16px;">üö® Emergency Helpline</h3>
        <div class="emergency-grid">
            <a href="tel:100" class="emergency-link">Police: 100</a>
            <a href="tel:108" class="emergency-link">Ambulance: 108</a>
            <a href="tel:181" class="emergency-link">Women Help: 181</a>
            <a href="tel:02692231651" class="emergency-link">SVIT Office</a>
        </div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://svit-bus-tracker-default-rtdb.asia-southeast1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const svitCoords = [22.4552, 73.0745];

        const svitRoutes = {
            "A-01": "SOMA TALAV, KRISHNA PARK, VRUNDAVAN, RUKSHMANI, SAMA SAVLI ROAD",
            "A-02": "GURUKUL, PARIVAR CHAR RASTA, MAHESH COMPLEX",
            "A-03": "JIVAN BHARTI, MUKTANAND, AMBALAL PARK, ANAND NAGAR",
            "A-04": "AMIT NAGAR, AMRAPALI, DUMAD CHOWKDI",
            "A-05": "BRIGHT SCHOOL, L&T CIRCLE, EME CIRCLE, UDIPI",
            "A-06": "MOTI NAGAR, SHIV VATIKA, SANGAM, AIRPORT CIRCLE",
            "A-07": "PUNAM COMPLEX, AYURVEDIC HOSPITAL, SURYA NAGAR",
            "A-08": "KAMLA NAGAR, SARDAR ESTATE, KHODIYAR NAGAR, HARNI",
            "A-09": "LAD BHAWAN, RELIENCE, VRUNDAVAN, PRABHAT, UMA CHAR RASTA",
            "A-10": "KISHAN VADI, KARELIBAUG WATER TANK",
            "A-11": "GORWA ITI, SAYHOG, PANCHVATI",
            "A-12": "ZYDEX, YASH COMPLEX, ISCON HEIGHT, LAXMI PURA",
            "A-13": "NATUBHAI CENTER, ELLORA PARK, KALPTARU, JAIN DERASAR",
            "A-14": "SAMTA, PAVAN DHAM, AAKANKSHA DUPLEX, PUSHPAK",
            "A-15": "ISCON TEMPLE, HARINAGAR, RAJESH TOWER, RANESHWAR",
            "A-16": "PANCHMUKHI HANUMAN, BANSAL STORE, TIME CIRCLE, D-MART",
            "A-17": "VISHVAMITRI, AKSHAR CHOWK, GENDA CIRCLE, VASAD",
            "A-18": "MUNJ MAHUDA, AKOTA GARDEN, RAMA KAKA DERI, VASAD",
            "A-19": "GAYATRINAGAR, MANEJA, NOVINO, SUSSEN, KALALI",
            "A-20": "SAI CHOKDI, MANJALPUR, DARBAR CHOKDI, TULSIDHAM, MOTIBAG",
            "A-21": "BARODA DAIRY, KABIR COMPLEX, KALA GHODA, CHHANI",
            "A-22": "TARSALI MARKET, SHARAD NAGAR, ONGC, RAJMAHAL ROAD",
            "A-23": "TAPAN, MOTI BAG, KIRTI STAMBH, CHHANI JAKAT NAKA",
            "A-24": "RAMESH PATEL ESTATE, DEEP CHAMBERS, SAFFRON TOWER",
            "A-25": "GOYA GATE, NAVAPURA, JAYRATNA BUILDING, POLOGROUND",
            "A-26": "SAMA GARDEN, CHAYANKYA PURI, ABHILASHA, M. B. HOSTEL",
            "AR-A-01": "Arch: NOVINO, SUSEN, AKSHAR CHOWK, GENDA CIRCLE, VASAD",
            "AR-A-02": "Arch: KALADARSHAN, UMA CHARRASTA, SANGAM, AMIT NAGAR"
        };

        var map = L.map('map').setView(svitCoords, 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var markers = {};
        var busIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/3448/3448339.png', iconSize: [35, 35] });

        // ADDED: Global Wake Lock variable
        let wakeLock = null; 
        let watchId = null;

        window.onload = function() {
            if (localStorage.getItem("role") === "driver") {
                document.getElementById("driverControls").style.display = "block";
                const sel = document.getElementById("routeSelect");
                for (let r in svitRoutes) { sel.options[sel.options.length] = new Option(r + " - " + svitRoutes[r], r); }
            }
        };

        function calculateMetrics(lat1, lon1, speed) {
            const R = 6371;
            const dLat = (svitCoords[0] - lat1) * Math.PI / 180;
            const dLon = (svitCoords[1] - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(svitCoords[0] * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const eta = Math.round((dist / 30) * 60);
            let traffic = { text: "Smooth", color: "var(--success)" };
            if (speed < 10) traffic = { text: "Heavy", color: "var(--danger)" };
            else if (speed < 20) traffic = { text: "Moderate", color: "var(--warning)" };
            return { eta: eta < 2 ? "Arriving" : eta + " mins", traffic };
        }

        // UPGRADED: confirmTrip now uses Wake Lock & strict GPS options
        async function confirmTrip() {
            // 1. Play audio to keep browser active
            document.getElementById("wakeLockAudio").play().catch(e => console.log(e));
            
            // 2. Request Wake Lock to keep CPU awake
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    document.getElementById('lockStatus').innerText = "üü¢ Pocket Lock Active: You can safely minimize.";
                    document.getElementById('lockStatus').style.color = "var(--success)";
                } catch (err) {
                    console.log("Wake Lock Failed: " + err.message);
                }
            }

            const b = document.getElementById("busId").value;
            const r = document.getElementById("routeSelect").value;
            database.ref('activeBuses/' + r).set({ busId: b, route: r, stops: svitRoutes[r], status: "LIVE" });
            
            // 3. Start High-Accuracy Background Tracking
            const geoOptions = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
            watchId = navigator.geolocation.watchPosition(pos => {
                database.ref('activeBuses/' + r).update({ 
                    lat: pos.coords.latitude, lon: pos.coords.longitude, 
                    speed: (pos.coords.speed || 0) * 3.6, lastSeen: new Date().toLocaleTimeString() 
                });
            }, null, geoOptions);
            
            alert("Trip Started!");
        }

        // UPGRADED: To release locks when finished
        function removeRoute() {
            const r = document.getElementById("routeSelect").value;
            if(confirm("End this trip?")) {
                database.ref('activeBuses/' + r).remove().then(() => {
                    if (wakeLock) wakeLock.release();
                    if (watchId) navigator.geolocation.clearWatch(watchId);
                    document.getElementById("wakeLockAudio").pause();
                    location.reload();
                });
            }
        }

        function clearAll() {
            if(confirm("Wipe map?")) database.ref('activeBuses').remove().then(() => location.reload());
        }

        database.ref('activeBuses').on('value', snap => {
            const data = snap.val();
            const body = document.getElementById("allocationBody");
            body.innerHTML = "";
            for (let k in markers) { map.removeLayer(markers[k]); delete markers[k]; }
            if (!data) return;
            for (let k in data) {
                const b = data[k];
                const metrics = b.lat ? calculateMetrics(b.lat, b.lon, b.speed || 0) : null;
                if (b.lat) markers[k] = L.marker([b.lat, b.lon], {icon: busIcon}).addTo(map).bindPopup(b.busId);
                body.innerHTML += `<tr>
                    <td><b>${b.busId}</b></td>
                    <td><b style="color:var(--accent)">Route ${b.route}</b><br><small>${b.stops}</small></td>
                    <td><span class="badge" style="background:var(--accent)">${metrics ? metrics.eta : '---'}</span><br>
                        <span class="badge" style="background:${metrics ? metrics.traffic.color : '#ccc'}">${metrics ? metrics.traffic.text : '---'}</span></td>
                    <td><span class="badge" style="background:var(--success)">‚óè LIVE</span><br><small>${b.lastSeen || ''}</small></td>
                </tr>`;
            }
        });

        function logout() { localStorage.clear(); window.location.href = "index.html"; }
        function search() {
            let q = document.getElementById("searchInput").value.toUpperCase();
            let rows = document.getElementById("allocationBody").rows;
            for (let r of rows) { r.style.display = r.innerText.toUpperCase().includes(q) ? "" : "none"; }
        }
    </script>
</body>
</html>